#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

# Use the pinned Rust toolchain for codex-rs.
export RUSTUP_TOOLCHAIN="1.90.0"

# Build artifacts must live on an executable filesystem. Since this
# repo lives on an NTFS mount, direct execution of binaries under it
# fails with SIGSEGV. Point Cargo's target dir into $HOME instead.
if [[ -z "${CARGO_TARGET_DIR:-}" ]]; then
  export CARGO_TARGET_DIR="$HOME/.cache/codex-target"
fi

mkdir -p "$CARGO_TARGET_DIR"

# Run the Codex binary from the Rust workspace, using the pinned
# Rust toolchain if specified, but keep the caller's current working
# directory so Codex operates on the project where you invoked `c-codex`.
cargo run \
  --manifest-path "$ROOT_DIR/codex-rs/Cargo.toml" \
  --bin codex -- "$@"
